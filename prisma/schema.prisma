generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String           @id @default(uuid())
  email          String           @unique
  name           String?
  password       String?
  role           Role             @default(USER)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  googleId       String?          @unique
  avatar         String?
  authProvider   AuthProvider     @default(LOCAL)
  refresh_tokens refresh_tokens[]
  students       students?
  tutors         tutors?

  @@map("users")
}

model Course {
  id          String        @id @default(uuid())
  title       String
  description String?
  price       Float         @default(0)
  isPublished Boolean       @default(false)
  tutorId     String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  tutors      tutors        @relation(fields: [tutorId], references: [id])
  enrollments enrollments[]

  @@map("courses")
}

model conversations {
  id        String             @id
  studentId String
  tutorId   String?
  subject   Subject            @default(GENERAL)
  topic     String?
  keywords  String[]           @default([])
  urgency   Urgency            @default(NORMAL)
  status    ConversationStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime
  students  students           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutors    tutors?            @relation(fields: [tutorId], references: [id])
  messages  messages[]
  call_logs call_logs[]
}

model enrollments {
  id         String           @id
  studentId  String
  courseId   String
  enrolledAt DateTime         @default(now())
  status     EnrollmentStatus @default(ACTIVE)
  courses    Course           @relation(fields: [courseId], references: [id])
  students   students         @relation(fields: [studentId], references: [id])

  @@unique([studentId, courseId])
}

model messages {
  id             String        @id
  conversationId String
  senderId       String
  senderType     SenderType
  content        String?
  messageType    MessageType   @default(TEXT)
  audioUrl       String?
  audioDuration  Int?
  transcription  String?
  attachments    Json?         // Array of { url: string, name: string, type: string, size: number }
  isRead         Boolean       @default(false)
  createdAt      DateTime      @default(now())
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model refresh_tokens {
  id        String   @id
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  users     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model students {
  id            String          @id
  userId        String          @unique
  grade         String?
  school        String?
  phoneNumber   String?
  dateOfBirth   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  conversations conversations[]
  enrollments   enrollments[]
  users         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model tutors {
  id            String          @id
  userId        String          @unique
  bio           String?
  qualification String?
  experience    Int?            @default(0)
  hourlyRate    Float?
  isVerified    Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  isAvailable   Boolean         @default(true)
  isBusy        Boolean         @default(false)
  busyUntil     DateTime?
  currentConversationId String?
  rating        Float?          @default(0)
  subjects      Subject[]       @default([])
  conversations conversations[]
  courses       Course[]
  users         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Pending tutor notifications for smart routing
model tutor_notifications {
  id             String   @id @default(uuid())
  conversationId String
  tutorId        String
  status         NotificationStatus @default(PENDING)
  sentAt         DateTime @default(now())
  respondedAt    DateTime?
  wave           Int      @default(1) // Which wave of notifications (1st, 2nd, 3rd...)
  createdAt      DateTime @default(now())

  @@index([conversationId])
  @@index([tutorId])
}

// Call logs for tracking audio/video calls
model call_logs {
  id             String      @id @default(uuid())
  conversationId String
  callerId       String      // User ID who initiated the call
  receiverId     String?     // User ID who received the call
  callType       CallType    @default(AUDIO)
  status         CallStatus  @default(INITIATED)
  startedAt      DateTime    @default(now())
  answeredAt     DateTime?
  endedAt        DateTime?
  duration       Int?        // Duration in seconds
  endReason      String?     // Reason for ending (declined, busy, timeout, completed, etc.)
  createdAt      DateTime    @default(now())

  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([callerId])
  @@index([receiverId])
}

enum CallType {
  AUDIO
  VIDEO
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  REJECTED
  MISSED
  ENDED
  FAILED
}

enum NotificationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum Role {
  USER
  ADMIN
  TUTOR
  STUDENT
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum ConversationStatus {
  PENDING
  ASSIGNED
  ACTIVE
  RESOLVED
  CLOSED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

enum MessageType {
  TEXT
  AUDIO
  IMAGE
  FILE
}

enum SenderType {
  STUDENT
  TUTOR
  SYSTEM
}

enum Subject {
  MATHEMATICS
  PHYSICS
  CHEMISTRY
  BIOLOGY
  ENGLISH
  HISTORY
  GEOGRAPHY
  COMPUTER_SCIENCE
  ECONOMICS
  ACCOUNTING
  GENERAL
}

enum Urgency {
  LOW
  NORMAL
  HIGH
  URGENT
}
